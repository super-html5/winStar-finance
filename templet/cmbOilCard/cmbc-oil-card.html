<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>民生银行用户免费领30加油劵</title>
    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script>
        //适配
        window.use_screen_base = '750';
        (function (a, b) {
            if (typeof(use_screen_base) != "undefined") {
                var c = "orientationchange" in b ? "orientationchange" : "resize",
                        d = use_screen_base.indexOf("_mate"),
                        e = parseInt(use_screen_base),
                        f = a.documentElement,
                        g = function () {
                            var a = f.clientWidth,
                                    c = b.innerWidth;
                            f.style.fontSize = 100 * (c / e) + "px"
                        };
                if (/iPad.*OS|iPhone.*OS/.test(navigator.userAgent) && d > 0) {
                    var h = a.querySelectorAll("meta[name=viewport]");
                    h[0] && h[0].setAttribute("content", "width=device-width, user-scalable=no, initial-scale=" + 1 / b.devicePixelRatio)
                }
                g(), b.addEventListener(c, g, !1), delete use_screen_base
            }
        })(document, window);

    </script>
    <style type="text/css">
        .positon-relative {
            position: relative;
        }

        .row {
            margin: 0;
        }

        .col-xs-12 {
            padding: 0;
        }

        .input-card, .button-card,.button-handle {
            position: absolute;
            outline: 0;
            border-radius: .5rem;
            text-align: center;
        }

        .input-card {
            left: 20%;
            right: 20%;
            width: 60%;
            z-index: 10;
            top: .05rem;
            border: 1px solid #cccccc;
            font-size: .3rem;
            color: #666;
            padding: .14rem .1rem;
        }

        .button-card,.button-handle {
            left: 10%;
            right: 10%;
            width: 80%;
            z-index: 11;
            top: .5rem;
            border: 0;
            font-size: .38rem;
            box-shadow: 0 0 0.2rem #777;
            background-color: #0079E1;
            color: #fff;
            padding: .24rem 2rem;
        }
        .button-handle{
            z-index: 12;
            top: 1.8rem;
            background-color: #FFBD2B;
        }
    </style>
</head>
<body>
<div class="container" style="padding:0;">
    <div class="row">
        <div class="col-xs-12"><img src="cmbc-img01.png" class="img-responsive"/></div>
        <div class="col-xs-12 positon-relative">
            <input id="phone" type="tel" maxlength="16" class="input-card" placeholder="请输入你的车车卡号码"/>
            <img src="cmbc-img02.png" class="img-responsive"/>
        </div>
        <div class="col-xs-12"><img src="cmbc-img03.png" class="img-responsive"/></div>
        <div class="col-xs-12 positon-relative">
            <button id="sub" type="button" class="button-card"><strong>领取油券</strong></button>
            <button id="btnHandle" type="button" class="button-handle"><strong>办理车车卡</strong></button>
            <img src="cmbc-img04.jpg" class="img-responsive"/>
        </div>
        <!--<div class="col-xs-12"><img src="cmbc-img05.jpg" class="img-responsive"/></div>-->
    </div>
</div>


<input type="hidden" id="discountCoupon"/>
<script>
    function getUrlParams(name, url) {
        if (!url) url = window.location.href;
        var params = {};
        var url = decodeURI(url);
        var idx = url.indexOf("?");
        if (idx > 0) {
            var queryStr = url.substring(idx + 1);
            var args = queryStr.split("&");
            for (var i = 0, a, nv; a = args[i]; i++) {
                nv = args[i] = a.split("=");
                params[nv[0]] = nv.length > 1 ? nv[1] : true;
            }
        }
        return params[name];
    }

    /**
     * 和APP端交互获取token_id
     * @returns {[*,*]} tempFlag == 0 为IOS设备 tempFlag == 1 为android设备
     * @private
     */
    var tokenIdCmbc = null;
    //    $("#discountCoupon").val('152185cdd0c847ca81da7a2ceb065710');
    //    var tel = 15319781855;
    var tel = getUrlParams('phoneNumber');
    _getTokenId();
    function _getTokenId() {
        var u = navigator.userAgent;
        var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
        var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
        if (isiOS) {
            window.webkit.messageHandlers.getMobleTokinIdFunc.postMessage("getTokenId");
        } else if (isAndroid) {
            tokenIdCmbc = androidBaseInterface.getToken();
            $("#discountCoupon").val(tokenIdCmbc);
        }
    }
    function getTokenId(tokenId) {
        $("#discountCoupon").val(tokenId);
    }
    //$("#discountCoupon").val();

    //领取优惠券
    $('#btnHandle').click(function () {
        location.href = 'https://creditcard.cmbc.com.cn/wsv2/step?encryptStr=RKlWXvNbxvU7Gp9cLMFMzeo3MkISPE63OF83e1RKdbl403yg09aTx7kzNumAMZZN0qEC0xpeukmqW3G3nNvw1u0aNBYxWvehuwONFNPRiYnxPkY7Po0vth3xmzrCIWW2EKc1efS1oS4DL3scEW6RXGIFVdH4X6qbFzMqM1nQFC5I1T9FQujS7fxrnK1OJtg7CX9NSKx1RAgUsP3LvTYky3nIX6%2FG6Qje%2F3kdG%2BtYyd1iSdY2Ezxbmmq5LIjz0zYWT9pdNm3SlBj7aVfI7StZm4zuCdEypq8l95nkUl%2F3OjIra1HvdHGWpAgfMgDUqdTmA70xjjjd5J8aMPRFihuasA%3D%3D&cardId=24&source=YX-XAWSD4#page=1';
    });

    $('#sub').click(function () {
        var cardNumber = $('#phone').val();
        if (cardNumber.length === 16) {
            var cardNumberSub = cardNumber.substring(0, 9);
            if (cardNumberSub === '622623030' ||
                    cardNumberSub === '622623031' ||
                    cardNumberSub === '622602019' ||
                    cardNumberSub === '622602020' ||
                    cardNumberSub === '622602605'
            ) {
                $.ajax({
                    //提交数据的类型 POST GET
                    type: "POST",
                    headers: {'Content-Type': 'application/json', 'token_id': $("#discountCoupon").val()},
                    //提交的网址
                    url: 'https://mobile.sxwinstar.net/wechat_access/api/v1/marketing/coupon/receive/ms?activityId=4&telPhone=' + tel + '&cardNumber=' + cardNumber,
//                 url: '/wechatApi-ng4/api/v1/marketing/coupon/receive/ms?activityId=4&telPhone=' + tel + '&cardNumber=' + cardNumber,
                    //返回数据的格式
                    dataType: "json",
                    //成功返回之后调用的函数
                    success: function (data) {
                        location.href = 'cmbc-oil-success.html';
                    },
                    //调用出错执行的函数
                    error: function (data) {
                        if (data.responseJSON.code == 'coupons.AuthFail') {
                            alert('你已经领取过！')
                        }
                        if (data.responseJSON.code == 'NotAllow') {
                            alert('活动未开始！')
                        }
                    }
                });
            } else {
                alert('输入卡号有误');
            }
        } else {
            alert('输入卡号有误');
        }
    });

</script>
</body>
</html>